<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Black Rock — Sign up (temp)</title>
  <link rel="stylesheet" href="css/styles-new.css">
  <link rel="stylesheet" href="css/mobile.css">
</*add-pwa-meta*/>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0f172a">
  <link rel="apple-touch-icon" href="assets/icon-glass-192.png">
  <meta name="mobile-web-app-capable" content="yes">
</head>
<body>
  <main class="terminal">
    <div class="terminal-window">
      <div class="brand">
        <div class="logo">
          <div class="logo-icon">◉</div>
          <div class="logo-text">
            <span class="green">Black</span><span class="orange">Rock</span>
          </div>
        </div>
      </div>

      <h1 class="welcome">Enter Your Details</h1>
      <p class="subtitle">We need some basic information</p>

      <button class="google-btn">
        <img src="assets/google.svg" alt="" class="google-icon">
        Continue with Google
      </button>

      <div class="divider">OR</div>

  <form id="signupForm" class="form signup-form">
        <div class="name-row">
          <div class="input-group">
            <div class="label-row">
              <svg class="input-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2 M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" stroke="currentColor" stroke-width="2"/>
              </svg>
              <span class="input-label">First Name</span>
            </div>
            <input type="text" class="input-field" placeholder="Enter your first name">
          </div>

          <div class="input-group">
            <div class="label-row">
              <svg class="input-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2 M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" stroke="currentColor" stroke-width="2"/>
              </svg>
              <span class="input-label">Last Name</span>
            </div>
            <input type="text" class="input-field" placeholder="Enter your last name">
          </div>
        </div>

        <div class="input-group">
          <div class="label-row">
            <svg class="input-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" stroke="currentColor" stroke-width="2"/>
            </svg>
            <span class="input-label">Email Address</span>
          </div>
          <input type="email" class="input-field" placeholder="you@example.com">
        </div>

        <div class="input-group">
          <div class="label-row">
            <svg class="input-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path d="M12 15v2m-6 4h12a2 2 0 002-2v-8a2 2 0 00-2-2H6a2 2 0 00-2 2v8a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8V7z" stroke="currentColor" stroke-width="2"/>
            </svg>
            <span class="input-label">Password</span>
          </div>
          <div class="password-field">
            <input id="signupPassword" type="password" class="input-field" placeholder="Enter your password">
            <button type="button" class="eye-btn">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" stroke="currentColor" stroke-width="2"/>
                <path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" stroke="currentColor" stroke-width="2"/>
              </svg>
            </button>
          </div>

          <div class="pw-requirements">
            <div class="req"><span class="dot">○</span>At least 8 characters</div>
            <div class="req"><span class="dot">○</span>Uppercase and lowercase letters</div>
            <div class="req"><span class="dot">○</span>Numbers and special characters</div>
          </div>
        </div>

        <div class="button-row">
          <a href="index.html" class="back-btn">← Back</a>
          <button type="submit" class="continue-btn">Continue →</button>
        </div>
      </form>

      <footer>
        <p class="login-text">Already have an account? <a href="index.html" class="login-link">Sign in</a></p>
        <p class="security"><span class="dot">◉</span> Secure • Encrypted • Private</p>
      </footer>
    </div>
  </main>

  <script src="js/auth-shared.js"></script>
  <script src="js/mobile-utils.js" defer></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      initializePasswordToggles();
      const signupPassword = document.getElementById('signupPassword');
      attachPasswordStrength(signupPassword);

      const form = document.querySelector('.signup-form');
      const googleBtn = document.querySelector('.google-btn');

      (function() {
        const signupForm = document.getElementById('signupForm');
        if (!signupForm) return console.warn('signupForm not found');

        async function handleSignupSubmit(e) {
          e.preventDefault();
          try {
            const formData = {
              firstName: signupForm.querySelector('input[placeholder="Enter your first name"]').value,
              lastName: signupForm.querySelector('input[placeholder="Enter your last name"]').value,
              email: signupForm.querySelector('input[type="email"]').value,
              password: signupForm.querySelector('input[type="password"]').value
            };

            const pwEval = evaluatePasswordStrength(formData.password);
            if (!formData.password || formData.password.length < 8) {
              showToast('Password must be at least 8 characters.', 'error');
              return;
            }

            const submitBtn = signupForm.querySelector('button[type="submit"]');
            const origText = submitBtn ? submitBtn.innerHTML : null;
            if (submitBtn) { submitBtn.disabled = true; submitBtn.innerHTML = 'Creating...'; }

            const response = await fetch('/api/auth/signup', {
              method: 'POST',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(formData)
            });

            const data = await response.json();
            if (response.ok) {
              console.log('Signup successful for', formData.email, data);
              // If there was a referral code in the URL, register it
              try {
                const urlParams = new URLSearchParams(window.location.search);
                const ref = urlParams.get('ref');
                if (ref && data.userId) {
                  // best-effort: inform server about the referral
                  fetch('/api/affiliate/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refCode: ref, referredUserId: data.userId })
                  }).catch(err => console.warn('Referral register failed', err));
                }
              } catch (e) {}

              if (data.isEmailVerified) {
                window.location.href = '/dashboard';
              } else {
                window.location.href = `/verify-email.html?email=${encodeURIComponent(formData.email)}`;
              }
            } else {
              console.warn('Signup failed', data);
              showToast(data.message || 'Signup failed. Please try again.', 'error');
            }
          } catch (err) {
            console.error('Signup error:', err);
            showToast('An error occurred. Please try again.', 'error');
          } finally {
            const submitBtn = signupForm.querySelector('button[type="submit"]');
            if (submitBtn) { submitBtn.disabled = false; if (origText) submitBtn.innerHTML = origText; }
          }
        }

        signupForm.addEventListener('submit', handleSignupSubmit);
        const submitBtn = signupForm.querySelector('button[type="submit"]');
        if (submitBtn) submitBtn.addEventListener('click', (e) => { e.preventDefault(); handleSignupSubmit(e); });
      })();

      googleBtn?.addEventListener('click', () => { window.location.href = '/api/auth/google'; });
    });
  </script>
  <script src="js/pwa-register.js" defer></script>
</body>
</html>
